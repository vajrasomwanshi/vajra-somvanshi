{{ 'custom-product-grid.css' | asset_url | stylesheet_tag }}
{% style %}
  .section-{{ section.id }} {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }

  {% for block in section.blocks %}
    .block-id-{{ block.id }}
    .custom-quickview-atc-btn {
      top: {{ block.settings.vertical }}%;
      left: {{ block.settings.horizontal }}%;
      transform: translate(-{{ block.settings.vertical }}%, -{{ block.settings.horizontal }}%);
    }
    .block-id-{{ block.id }}.custom-quickview-atc-btn:hover {
      transform: translate(-{{ block.settings.vertical }}%, -{{ block.settings.horizontal }}%) scale(1.1);
    }
  {% endfor %}

  @media screen and (max-width: 906px) {
    .section-{{ section.id }} {
      padding-top: {{ section.settings.padding_top | times: 0.45 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.45 }}px;
    }
  }
{% endstyle %}

<div class="page-width custom-product-grid-container section-{{ section.id }}">
  {% if section.settings.heading != blank %}
    <h3 class="custom-product-grid__title">
      {{ section.settings.heading }}
    </h3>
  {% endif %}
  <div class="custom-product-grid-wrapper">
    {% for block in section.blocks %}
      <div class="custom-product-grid__item block-id-{{ block.id }}">
        <img
          src="{{ block.settings.product.featured_media | image_url }}"
          alt="{{ block.settings.product.featured_media.alt }}"
          width="{{ block.settings.product.featured_media.width }}"
          height="{{ block.settings.product.featured_media.height }}">
        <button
          class="custom-quickview-atc-btn"
          data-product-handle="{{ block.settings.product.handle }}"
          data-product-id="{{ block.settings.product.id }}">
          {{ 'icon-atc-plus.svg' | inline_asset_content }}
        </button>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Quickview Modal -->
<div class="quickview-modal" id="quickviewModal">
  <div class="quickview-modal__content">
    <button class="quickview-modal__close" id="closeModal">
      {{ 'icon-popup-close.svg' | inline_asset_content }}
    </button>
    <div class="quickview-modal__body">
      <div class="quickview-modal__body-inner-wrapper">
        <div class="quickview-modal__image">
          <img
            id="modalImage"
            src=""
            alt="">
        </div>
        <div class="quickview-modal__body-content">
          <h4 class="quickview-modal__title" id="modalTitle"></h4>
          <div class="quickview-modal__price" id="modalPrice"></div>
          <div class="quickview-modal__description" id="modalDescription"></div>
        </div>
      </div>
      <div class="quickview-modal__details">
        <div id="modalOptions"></div>
        <button class="quickview-modal__atc-btn" id="modalAddToCart">
          ADD TO CART
          <span class="span-right-arrow">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="36"
              height="12"
              viewBox="0 0 36 12"
              fill="none"><path d="M0.75 4.77295L9.20657e-08 4.77295L-9.20657e-08 6.27295L0.75 6.27295L0.75 4.77295ZM34.9798 6.05328C35.2727 5.76039 35.2727 5.28551 34.9798 4.99262L30.2068 0.21965C29.9139 -0.0732432 29.4391 -0.0732433 29.1462 0.21965C28.8533 0.512544 28.8533 0.987417 29.1462 1.28031L33.3888 5.52295L29.1462 9.76559C28.8533 10.0585 28.8533 10.5334 29.1462 10.8263C29.4391 11.1191 29.9139 11.1191 30.2068 10.8263L34.9798 6.05328ZM0.75 6.27295L34.4495 6.27295L34.4495 4.77295L0.75 4.77295L0.75 6.27295Z" fill="white" /></svg>
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById('quickviewModal');
    const closeBtn = document.getElementById('closeModal');
    const addToCartBtn = document.getElementById('modalAddToCart');
    let currentProduct = null;
    let selectedVariant = null;
  
    // Color map for color names to hex values
    function getColorMap() {
        return {
            'black': '#000000',
            'white': '#ffffff',
            'red': '#ff0000',
            'blue': '#0000ff',
            'green': '#008000',
            'yellow': '#ffff00',
            'gray': '#808080',
            'grey': '#808080',
            'navy': '#000080',
            'navy blue': '#000080',
            'dark blue': '#00008b',
            'light blue': '#add8e6',
            'pink': '#ffc0cb',
            'purple': '#800080',
            'orange': '#ffa500',
            'brown': '#a52a2a',
            'gold': '#ffd700',
            'silver': '#c0c0c0',
            'beige': '#f5f5dc',
            'cream': '#fffdd0'
        };
    }
  
    // Handle select rotation
    function setupSelectRotation(selectElement) {
        selectElement.addEventListener('mousedown', function() {
            this.classList.add('open');
            rotateSelectArrow(this, true);
        });
  
        selectElement.addEventListener('change', function() {
            // Keep open state until blur
        });
  
        selectElement.addEventListener('blur', function() {
            this.classList.remove('open');
            rotateSelectArrow(this, false);
        });
    }
  
    function rotateSelectArrow(selectElement, isOpen) {
        if (isOpen) {
            selectElement.style.backgroundImage = 
                'linear-gradient(to right, transparent 0%, transparent calc(100% - 45px), #000000 calc(100% - 45px), #000000 calc(100% - 44px), transparent calc(100% - 44px)),' +
                'url("data:image/svg+xml,%3Csvg width=\'15\' height=\'9\' viewBox=\'0 0 15 9\' fill=\'none\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M13.0607 7.06067L7.06067 1.06067L1.06067 7.06067\' stroke=\'black\' stroke-width=\'1.5\' stroke-linecap=\'square\'/%3E%3C/svg%3E")';
        } else {
            selectElement.style.backgroundImage = 
                'linear-gradient(to right, transparent 0%, transparent calc(100% - 45px), #000000 calc(100% - 45px), #000000 calc(100% - 44px), transparent calc(100% - 44px)),' +
                'url("data:image/svg+xml,%3Csvg width=\'15\' height=\'9\' viewBox=\'0 0 15 9\' fill=\'none\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M1.06067 1.06067L7.06067 7.06067L13.0607 1.06067\' stroke=\'black\' stroke-width=\'1.5\' stroke-linecap=\'square\'/%3E%3C/svg%3E")';
        }
    }
  
    // Open modal when clicking quickview buttons
    document.querySelectorAll('.custom-quickview-atc-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const productHandle = this.getAttribute('data-product-handle');
            await loadProduct(productHandle);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
    });
  
    // Close modal
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
  
    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
  
    // Load product data
    async function loadProduct(handle) {
        try {
            const response = await fetch(`/products/${handle}.js`);
            currentProduct = await response.json();
            selectedVariant = currentProduct.variants[0];
            renderProduct();
        } catch (error) {
            console.error('Error loading product:', error);
        }
    }
  
    // Render product in modal
    function renderProduct() {
        if (!currentProduct) return;
  
        document.getElementById('modalImage').src = currentProduct.featured_image;
        document.getElementById('modalTitle').textContent = currentProduct.title;
        document.getElementById('modalPrice').textContent = formatMoney(selectedVariant.price);
        const description = currentProduct.description;
        const words = description.split(' ');
        const truncated = words.slice(0, 15).join(' ') + (words.length > 15 ? '' : '');
        document.getElementById('modalDescription').innerHTML = truncated;
        renderOptions();
        updateAddToCartButton();
    }
  
    // Render variant options
    function renderOptions() {
        const optionsContainer = document.getElementById('modalOptions');
        optionsContainer.innerHTML = '';
  
        if (currentProduct.options.length === 1 && currentProduct.options[0].name === 'Title') {
            return;
        }
  
        currentProduct.options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'quickview-modal__options';
  
            const label = document.createElement('label');
            label.className = 'quickview-modal__option-label';
            label.textContent = option.name;
            optionDiv.appendChild(label);
  
            // Show Size as dropdown, other options as buttons
            if (option.name.toLowerCase() === 'size') {
                // Always show size as dropdown
                const select = document.createElement('select');
                select.className = 'quickview-modal__select';
                
                option.values.forEach(value => {
                    const optionEl = document.createElement('option');
                    optionEl.value = value;
                    optionEl.textContent = value;
                    if (selectedVariant[`option${index + 1}`] === value) {
                        optionEl.selected = true;
                    }
                    select.appendChild(optionEl);
                });
                
                select.addEventListener('change', (e) => {
                    updateVariant(index, e.target.value);
                });
  
                // Setup rotation for this select
                setupSelectRotation(select);
                
                optionDiv.appendChild(select);
            } else {
                // Show other options (like Color) as buttons with color bar
                const btnContainer = document.createElement('div');
                btnContainer.className = 'quickview-modal__variant-selector';
                
                option.values.forEach(value => {
                    const btn = document.createElement('button');
                    btn.className = 'quickview-modal__variant-btn';
                    btn.type = 'button';
                    
                    // Create wrapper for button and color bar
                    const btnWrapper = document.createElement('div');
                    btnWrapper.className = 'quickview-modal__variant-btn-wrapper';
                    
                    // Create color bar element
                    const colorBar = document.createElement('div');
                    colorBar.className = 'quickview-modal__color-bar';
                    
                    // Try to fetch the actual color for this variant
                    const variantWithColor = currentProduct.variants.find(v => {
                        const options = [
                            selectedVariant.option1,
                            selectedVariant.option2,
                            selectedVariant.option3
                        ];
                        options[index] = value;
                        return v.option1 === options[0] &&
                               (options[1] === undefined || v.option2 === options[1]) &&
                               (options[2] === undefined || v.option3 === options[2]);
                    });
                    
                    // Set color bar background
                    const colorMap = getColorMap();
                    colorBar.style.backgroundColor = colorMap[value.toLowerCase()] || value;
                    
                    btn.textContent = value;
                    
                    if (selectedVariant[`option${index + 1}`] === value) {
                        btn.classList.add('active');
                    }
                    
                    btn.addEventListener('click', () => {
                        updateVariant(index, value);
                    });
                    
                    // Append color bar and button to wrapper
                    btnWrapper.appendChild(colorBar);
                    btnWrapper.appendChild(btn);
                    btnContainer.appendChild(btnWrapper);
                });
                
                optionDiv.appendChild(btnContainer);
            }
  
            optionsContainer.appendChild(optionDiv);
        });
    }
  
    // Update selected variant
    function updateVariant(optionIndex, value) {
        const options = [
            selectedVariant.option1,
            selectedVariant.option2,
            selectedVariant.option3
        ];
        options[optionIndex] = value;
  
        const newVariant = currentProduct.variants.find(v => {
            return v.option1 === options[0] &&
                   (options[1] === undefined || v.option2 === options[1]) &&
                   (options[2] === undefined || v.option3 === options[2]);
        });
  
        if (newVariant) {
            selectedVariant = newVariant;
            document.getElementById('modalPrice').textContent = formatMoney(selectedVariant.price);
            renderOptions();
            updateAddToCartButton();
        }
    }
  
    // Update add to cart button state
    function updateAddToCartButton() {
        if (selectedVariant.available) {
            addToCartBtn.disabled = false;
            addToCartBtn.innerHTML = 'ADD TO CART <span class="span-right-arrow"><svg xmlns="http://www.w3.org/2000/svg" width="36" height="12" viewBox="0 0 36 12" fill="none"><path d="M0.75 4.77295L9.20657e-08 4.77295L-9.20657e-08 6.27295L0.75 6.27295L0.75 4.77295ZM34.9798 6.05328C35.2727 5.76039 35.2727 5.28551 34.9798 4.99262L30.2068 0.21965C29.9139 -0.0732432 29.4391 -0.0732433 29.1462 0.21965C28.8533 0.512544 28.8533 0.987417 29.1462 1.28031L33.3888 5.52295L29.1462 9.76559C28.8533 10.0585 28.8533 10.5334 29.1462 10.8263C29.4391 11.1191 29.9139 11.1191 30.2068 10.8263L34.9798 6.05328ZM0.75 6.27295L34.4495 6.27295L34.4495 4.77295L0.75 4.77295L0.75 6.27295Z" fill="white"/></svg></span>';
        } else {
            addToCartBtn.disabled = true;
            addToCartBtn.textContent = 'SOLD OUT';
        }
    }
  
    // Add to cart
    addToCartBtn.addEventListener('click', async function() {
        if (!selectedVariant || !selectedVariant.available) return;
  
        this.disabled = true;
        this.textContent = 'ADDING...';
  
        try {
            const response = await fetch('/cart/add.js', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: selectedVariant.id,
                    quantity: 1
                })
            });
  
            if (response.ok) {
                this.textContent = 'ADDED!';
                setTimeout(() => {
                    closeModal();
                    // Trigger cart update event
                    document.documentElement.dispatchEvent(new CustomEvent('cart:refresh'));
                }, 500);
            } else {
                throw new Error('Failed to add to cart');
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            this.textContent = 'ERROR';
            setTimeout(() => {
                updateAddToCartButton();
            }, 2000);
        }
    });
  
    // Format money
    function formatMoney(cents) {
        const amount = (cents / 100).toFixed(2);
        return `{{ cart.currency.symbol }}${amount}`;
    }
  })();
</script>

{% schema %}
  {
    "name": "Custom Product grid",
    "settings": [
      {
        "type": "text",
        "id": "heading",
        "label": "Heading"
      }, {
        "type": "range",
        "id": "padding_top",
        "label": "Top spacing",
        "min": 0,
        "max": 100,
        "step": 10,
        "default": 90
      }, {
        "type": "range",
        "id": "padding_bottom",
        "label": "Bottom spacing",
        "min": 0,
        "max": 100,
        "step": 10,
        "default": 50
      }
    ],
    "blocks": [
      {
        "type": "product",
        "name": "Product",
        "limit": 6,
        "settings": [
          {
            "type": "product",
            "id": "product",
            "label": "Select Product"
          }, {
            "type": "header",
            "content": "Add to cart icon position"
          }, {
            "type": "range",
            "id": "horizontal",
            "label": "Horizontal position",
            "min": 0,
            "max": 100,
            "default": 50,
            "step": 1
          }, {
            "type": "range",
            "id": "vertical",
            "label": "Vertical position",
            "min": 0,
            "max": 100,
            "default": 50,
            "step": 1
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Custom Product grid"
      }
    ]
  }
{% endschema %}